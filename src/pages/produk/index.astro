---
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import site from "../../site.config";
import { withBase } from "../../utils/helpers";

// Ambil semua produk
const products = await getCollection("products");

// Helper tampilkan harga
const fmtIDR = (n: number, currency = "IDR") =>
  new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency,
    maximumFractionDigits: 0,
  }).format(n);

// Normalisasi gambar pertama (opsional)
const getCover = (images: any[], fallback = "/og-image.png") => {
  if (!Array.isArray(images) || images.length === 0) return withBase(fallback);
  const first = typeof images[0] === "string" ? images[0] : images[0]?.src || images[0];
  const src = typeof first === "string" ? first : String(first);
  return /^https?:\/\//i.test(src) ? src : withBase(src.startsWith("/") ? src : `/${src}`);
};
---

<MainLayout pageTitle={`Produk | ${site.title}`} activePage="produk">
  <section class="mx-auto max-w-5xl px-4 md:px-6">
    <h1 class="mb-6 text-center text-3xl font-semibold">Produk</h1>

    <!-- Grid kartu produk -->
    <div class="mx-auto grid max-w-3xl gap-6">
      {products.map((p) => {
        const d: any = p.data || {};
        const title: string = d.title ?? p.id ?? "Produk";
        const slug: string = (p.slug as any) ?? p.id.replace(/\.(md|mdx)$/, "");
        const price: number | undefined = typeof d.price === "number" ? d.price : undefined;
        const currency: string = d.currency ?? "IDR";
        const buyUrl: string = d.url || "#";
        const cover = getCover(d.images);

        return (
          <article class="rounded-2xl border p-4">
            <div class="overflow-hidden rounded-xl">
              <img
                src={cover}
                alt={title}
                class="h-56 w-full rounded-xl object-cover"
                loading="lazy"
                decoding="async"
              />
            </div>

            <div class="mt-4 space-y-2">
              <h2 class="text-center text-xl font-semibold">{title}</h2>

              {price !== undefined && (
                <p class="text-center font-medium">{fmtIDR(price, currency)}</p>
              )}

              <!-- Tampilkan slug kecil -->
              <p class="text-center text-sm text-neutral-500">/{slug}</p>

              <div class="mt-2 flex justify-center">
                <a
                  href={buyUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center rounded-full border px-5 py-2 font-medium hover:bg-black hover:text-white transition"
                >
                  Beli
                </a>
              </div>
            </div>
          </article>
        );
      })}
    </div>
  </section>
</MainLayout>
