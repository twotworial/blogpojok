---
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import siteConfig from "../../site.config";
import { withBase } from "../../utils/helpers";

const siteBase = Astro.site ?? siteConfig.website ?? "https://twotworial.com";
const pageTitle = "Produk";
const pageDescription = "Katalog produk & jasa Twotworial.";

// Ambil & urutkan
const products = (await getCollection("products")).sort((a, b) => {
  const da = a.data.date ? new Date(a.data.date).getTime() : 0;
  const db = b.data.date ? new Date(b.data.date).getTime() : 0;
  return db - da;
});

// helper gambar: string atau object {src}
const firstImg = (p:any) => {
  const imgs = Array.isArray(p?.data?.images) ? p.data.images : [];
  if (!imgs.length) return undefined;
  const raw = typeof imgs[0] === "string" ? imgs[0] : imgs[0]?.src;
  if (!raw) return undefined;
  // jika sudah absolute atau mulai dengan / maka biarkan
  return /^https?:\/\//i.test(raw) ? raw : (raw.startsWith("/") ? raw : `/${raw}`);
};

// JSON-LD ItemList
const itemListJSONLD = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  itemListElement: products.map((p, i) => ({
    "@type": "ListItem",
    position: i + 1,
    url: new URL(`/produk/${p.slug}/`, siteBase).href,
    name: p.data.title,
    image: firstImg(p),
  })),
};
---
<MainLayout
  activePage="produk"
  pageTitle={`${pageTitle} | ${siteConfig.title}`}
  description={pageDescription}
  breadcrumbTitle="Produk"
>
  <script type="application/ld+json" is:inline>
    {JSON.stringify(itemListJSONLD).replace(/</g, "\\u003c")}
  </script>

  <section class="page-content">
    <h1 class="text-balance">{pageTitle}</h1>

    <input
      type="search"
      name="q"
      placeholder="Cari produk..."
      class="w-full rounded-3xl px-5 py-3 my-4"
      aria-label="Cari produk"
    />

    {products.length === 0 ? (
      <div class="rounded-3xl border px-5 py-8 text-center">
        <p class="mb-2">Belum ada produk.</p>
        <p class="text-sm text-gray-600">
          Tambahkan file di <code>src/content/products/*.md</code>.
        </p>
      </div>
    ) : (
      <div class="grid gap-6 sm:grid-cols-2">
        {products.map((p) => {
          const url = withBase(`/produk/${p.slug}/`);
          const img = firstImg(p);
          return (
            <article class="rounded-2xl border p-4">
              {img && (
                <a href={url} class="block mb-3 overflow-hidden rounded-xl">
                  <div class="w-full aspect-square">
                    <img
                      src={img}
                      alt={p.data.title}
                      class="h-full w-full object-cover"
                      loading="lazy"
                      decoding="async"
                    />
                  </div>
                </a>
              )}

              <h2 class="text-lg font-semibold mb-1">
                <a href={url} class="hover:underline">{p.data.title}</a>
              </h2>

              {p.data.excerpt && <p class="text-sm mb-3">{p.data.excerpt}</p>}

              <div class="flex items-center justify-between">
                {typeof p.data.price === "number" && (
                  <span class="font-medium">
                    {new Intl.NumberFormat("id-ID", {
                      style: "currency",
                      currency: p.data.currency ?? "IDR",
                      maximumFractionDigits: 0,
                    }).format(p.data.price)}
                  </span>
                )}
                <a href={url} class="button-link space-btn-outlined text-sm">Lihat Detail</a>
              </div>
            </article>
          );
        })}
      </div>
    )}
  </section>
</MainLayout>
