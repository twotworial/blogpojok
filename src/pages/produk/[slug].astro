---
// src/pages/produk/[slug].astro
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import siteConfig from "../../site.config";
import { withBase } from "../../utils/helpers";

// 1) Bangun semua path statis: slug wajib STRING (bukan array)
export async function getStaticPaths() {
  const products = await getCollection(
    "products",
    (p) => p.data?.draft !== true && !p.id.startsWith("_") // skip draft & file awalan "_"
  );

  return products.map((p) => {
    // Ambil segmen terakhir agar selalu string (mis: "lemari-minimalis")
    const slug = (p.slug ?? p.id).split("/").pop();
    return { params: { slug }, props: { product: p } };
  });
}

// 2) Data produk untuk halaman ini
const { product } = Astro.props;
const data = product.data;

// Meta
const siteBase = Astro.site ?? siteConfig.website ?? "https://twotworial.com";
const slug = (product.slug ?? product.id).split("/").pop();
const canonicalUrl = new URL(`/produk/${slug}/`, siteBase).href;

const pageTitle = data.metaTitle ?? data.title;
const pageDescription =
  data.metaDescription ?? data.excerpt ?? siteConfig.description;

const ogImage =
  (data.images?.[0]?.src &&
    new URL(withBase(data.images[0].src), siteBase).href) ||
  new URL(withBase(siteConfig.image?.src ?? "/TwotworialSQ.webp"), siteBase)
    .href;

// Breadcrumb JSON-LD
const breadcrumbJSONLD = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: new URL("/", siteBase).href },
    { "@type": "ListItem", position: 2, name: "Produk", item: new URL("/produk/", siteBase).href },
    { "@type": "ListItem", position: 3, name: data.title, item: canonicalUrl },
  ],
};
---

<MainLayout
  activePage="produk"
  pageTitle={pageTitle}
  description={pageDescription}
  image={ogImage}
  breadcrumbTitle={data.title}
>
  <script type="application/ld+json" is:inline>
    {JSON.stringify(breadcrumbJSONLD).replace(/</g, "\\u003c")}
  </script>

  <div class="page-content">
    <h1 class="text-balance">{data.title}</h1>

    {data.images?.[0]?.src && (
      <img
        src={withBase(data.images[0].src)}
        alt={data.images?.[0]?.alt ?? data.title}
        class="mb-6 rounded-2xl"
        width="1200"
        height="675"
        loading="eager"
      />
    )}

    {data.excerpt && <p class="mb-6">{data.excerpt}</p>}

    {data.price !== undefined && (
      <p class="mb-4 font-semibold">
        {new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: data.currency ?? "IDR",
          maximumFractionDigits: 0,
        }).format(data.price)}
      </p>
    )}

    {data.url && (
      <a
        href={data.url}
        target="_blank"
        rel="noopener noreferrer"
        class="button-link space-btn-filled"
      >
        Beli / Hubungi
      </a>
    )}
  </div>
</MainLayout>
