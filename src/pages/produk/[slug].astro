---
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";
import { withBase } from "../../utils/helpers";
import siteConfig from "../../site.config";

/* Normalisasi URL gambar dari /public atau http(s) */
function imgUrl(raw?: string) {
  if (!raw) return undefined;
  if (/^https?:\/\//i.test(raw)) return raw;          // URL eksternal
  return raw.startsWith("/") ? raw : `/${raw}`;        // file di /public
}

/* ==== ROUTING: generate semua path tanpa helper eksternal ==== */
export async function getStaticPaths() {
  const all = await getCollection("products");

  const paths = all
    .map((p) => {
      // hitung slug langsung
      let s: string | undefined;

      if (typeof p.slug === "string" && p.slug) s = p.slug;
      else if (typeof p.data?.slug === "string" && p.data.slug) s = p.data.slug;
      else {
        const last = (p.id || "").split("/").pop() || "";
        const base = last.replace(/\.(md|mdx)$/i, "");
        s = base || undefined;
      }

      return s ? { params: { slug: s } } : null;
    })
    .filter(Boolean) as Array<{ params: { slug: string } }>;

  return paths;
}

/* ==== LOAD DATA PRODUK ==== */
const { slug } = Astro.params;
const all = await getCollection("products");

const entry =
  all.find((p) => {
    // bandingkan tiga kemungkinan slug
    const a = typeof p.slug === "string" ? p.slug : undefined;
    const b = typeof p.data?.slug === "string" ? p.data.slug : undefined;
    const c = (() => {
      const last = (p.id || "").split("/").pop() || "";
      const base = last.replace(/\.(md|mdx)$/i, "");
      return base || undefined;
    })();

    return [a, b, c].some((v) => v === slug);
  }) ??
  (() => {
    throw new Error(`Produk dengan slug "${slug}" tidak ditemukan`);
  })();

const data = entry.data ?? {};
const siteBase = Astro.site?.href ?? siteConfig.website ?? "https://twotworial.com";
const canonical = new URL(`/produk/${slug}/`, siteBase).href;

/* images: dukung array string atau object {src,alt} */
const images: Array<{ src: string; alt?: string }> = Array.isArray(data.images)
  ? data.images.map((it: any) =>
      typeof it === "string" ? { src: it, alt: data.title } : it
    )
  : [];

/* JSON-LD Product */
const productJSONLD = {
  "@context": "https://schema.org",
  "@type": "Product",
  name: data.title,
  description: data.excerpt ?? data.description ?? "",
  image: images.map((i) => new URL(imgUrl(i.src)!, siteBase).href),
  offers: {
    "@type": "Offer",
    priceCurrency: data.currency ?? "IDR",
    price: typeof data.price === "number" ? String(data.price) : undefined,
    availability: data.availability ? `https://schema.org/${data.availability}` : undefined,
    url: canonical
  }
};

/* JSON-LD Breadcrumb */
const breadcrumbJSONLD = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: siteBase },
    { "@type": "ListItem", position: 2, name: "Produk", item: new URL("/produk/", siteBase).href },
    { "@type": "ListItem", position: 3, name: data.title, item: canonical }
  ]
};
---

<MainLayout
  activePage="produk"
  pageTitle={`${data.title} | ${siteConfig.title}`}
  description={data.excerpt ?? data.description ?? ""}
  breadcrumbTitle={data.title}
  canonical={canonical}
>
  <!-- Schema di-escape agar lolos Rich Results -->
  <script type="application/ld+json" is:inline>
    {JSON.stringify(productJSONLD).replace(/</g, "\\u003c")}
  </script>
  <script type="application/ld+json" is:inline>
    {JSON.stringify(breadcrumbJSONLD).replace(/</g, "\\u003c")}
  </script>

  <section class="page-content">
    <!-- Header card + share -->
    <div class="rounded-2xl border p-5 mb-6 flex flex-wrap items-center justify-between gap-4">
      <h1 class="text-2xl font-semibold m-0">{data.title}</h1>
      <div class="flex gap-2">
        <a
          class="space-btn-outlined button-link text-sm"
          href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(canonical)}&text=${encodeURIComponent(data.title)}`}
          target="_blank" rel="noopener nofollow"
        >Bagikan X</a>
        <a
          class="space-btn-outlined button-link text-sm"
          href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(canonical)}`}
          target="_blank" rel="noopener nofollow"
        >Bagikan FB</a>
      </div>
    </div>

    <!-- Harga + CTA -->
    <div class="text-center mb-6">
      {typeof data.price === "number" && (
        <p class="mb-3 font-semibold">
          {new Intl.NumberFormat("id-ID", { style: "currency", currency: data.currency ?? "IDR", maximumFractionDigits: 0 }).format(data.price)}
        </p>
      )}
      {data.url && (
        <a href={data.url} class="button-link space-btn-filled">Beli / Hubungi</a>
      )}
    </div>

    <!-- Galeri 1:1 full lebar container -->
    {images.length > 0 && (
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
        {images.map((img, i) => (
          <img
            src={imgUrl(img.src)}
            alt={img.alt || data.title}
            class="w-full aspect-square object-cover rounded-xl"
            loading={i === 0 ? "eager" : "lazy"}
            decoding="async"
          />
        ))}
      </div>
    )}

    <!-- Tab Deskripsi / Detail -->
    <div class="rounded-2xl border p-4 mb-6">
      <div class="flex gap-3 mb-4">
        <button class="tab-btn space-btn-outlined px-4 py-2 rounded-full" data-tab="desc">Deskripsi</button>
        <button class="tab-btn space-btn-outlined px-4 py-2 rounded-full" data-tab="detail">Detail</button>
      </div>

      <div id="tab-desc" class="prose max-w-none">
        {data.excerpt && <p>{data.excerpt}</p>}
        <slot />
      </div>

      <div id="tab-detail" class="prose max-w-none hidden">
        <ul class="list-disc pl-5">
          {data.sku && <li><b>SKU:</b> {data.sku}</li>}
          {data.brand && <li><b>Merek:</b> {data.brand}</li>}
          {Array.isArray(data.tags) && data.tags.length > 0 && <li><b>Tags:</b> {data.tags.join(", ")}</li>}
          {data.availability && <li><b>Ketersediaan:</b> {data.availability}</li>}
        </ul>
      </div>
    </div>

    {data.url && (
      <div class="text-center">
        <a href={data.url} class="button-link space-btn-filled">Beli Sekarang</a>
      </div>
    )}
  </section>

  <script is:inline>
    const btns = document.querySelectorAll(".tab-btn");
    const desc = document.getElementById("tab-desc");
    const detail = document.getElementById("tab-detail");
    btns.forEach((b) => b.addEventListener("click", () => {
      const which = b.dataset.tab;
      if (which === "desc") { desc?.classList.remove("hidden"); detail?.classList.add("hidden"); }
      else { detail?.classList.remove("hidden"); desc?.classList.add("hidden"); }
    }));
  </script>
</MainLayout>
