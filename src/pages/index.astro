---
import { getCollection } from "astro:content";
import MainLayout from "../layouts/MainLayout.astro";
import siteConfig from "../site.config";
import { sortItemsByDateDesc, withBase } from "../utils/helpers";
import PostCardPreview from "../components/PostCardPreview.astro";
import Button from "../components/Button.astro";
import heroImageUrl from "../assets/images/pixeltrue-space-discovery.svg?url";

const allPosts = (await getCollection("blogs")).sort(sortItemsByDateDesc);
const recentPosts = allPosts.slice(0, siteConfig.recentPostLimit ?? 6);

const pageTitle = siteConfig.title + " | Konsultan & Drafter Furniture - Costing, Draftlist, & Gambar Kerja";
const pageDescription =
  "Drafter & konsultan furniture untuk UMKM/manufaktur: gambar kerja profesional, costing & COGS, draftlist, serta artikel praktik harian bengkel.";

const siteBase = Astro.site ?? siteConfig.website ?? "https://twotworial.com";

/* ================= JSON-LD objects ================= */
const websiteJSONLD = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": siteConfig.title,
  "url": new URL("/", siteBase).href,
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${new URL("/", siteBase).href}?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

const organizationJSONLD = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": siteConfig.title,
  "url": new URL("/", siteBase).href,
  "logo": new URL(siteConfig.image?.src ?? "/TwotworialSQ.webp", siteBase).href
};

const collectionJSONLD = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": pageTitle,
  "description": pageDescription,
  "url": new URL("/", siteBase).href,
  "hasPart": {
    "@type": "ItemList",
    "itemListElement": recentPosts.map((p, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "url": new URL(withBase(`/blog/${p.id}`), siteBase).href,
      "name": p.data.title
    }))
  }
};

const navLinks = siteConfig?.headerNavLinks ?? [];
const navJSONLD = navLinks.length
  ? {
      "@context": "https://schema.org",
      "@type": "SiteNavigationElement",
      "name": navLinks.map(l => l.text),
      "url": navLinks.map(l => new URL(withBase(l.href), siteBase).href)
    }
  : null;
---

<MainLayout
  activePage="home"
  pageTitle={pageTitle}
  description={pageDescription}
  image={siteConfig.image?.src ?? "/TwotworialSQ.webp"}
>
  <!-- JSON-LD: pastikan is:inline dan nama variabel MATCH -->
  <script type="application/ld+json" is:inline>
    {JSON.stringify(websiteJSONLD).replace(/</g, "\\u003c")}
  </script>
  <script type="application/ld+json" is:inline>
    {JSON.stringify(organizationJSONLD).replace(/</g, "\\u003c")}
  </script>
  <script type="application/ld+json" is:inline>
    {JSON.stringify(collectionJSONLD).replace(/</g, "\\u003c")}
  </script>
  {navJSONLD && (
    <script type="application/ld+json" is:inline>
      {JSON.stringify(navJSONLD).replace(/</g, "\\u003c")}
    </script>
  )}

  <!-- ...sisanya (hero, grid artikel, dll) tetap seperti sekarang... -->
</MainLayout>
