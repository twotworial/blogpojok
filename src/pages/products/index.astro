---
import { getCollection } from "astro:content";
import MainLayout from "../../layouts/MainLayout.astro";
import ProductCard from "../../components/ProductCard.astro";
import siteConfig from "../../site.config";

const all = await getCollection("products");
const products = all.map((p) => {
  const data: any = p.data;
  // slug: frontmatter.slug || id (nama file)
  const slug = (data.slug || p.id).toString().replace(/\.mdx?$/i, "");
  return { ...data, id: p.id, slug };
}).sort((a, b) => (b.date?.getTime?.() ?? 0) - (a.date?.getTime?.() ?? 0));

const pageTitle = "Products — " + siteConfig.title;
const pageDescription = "Katalog produk/layanan dari Twotworial.";
---

<MainLayout activePage="products" pageTitle={pageTitle} description={pageDescription}>
  <section class="page-content">
    <h1 class="mb-4 text-balance">Products</h1>

    <!-- Search -->
    <div class="mb-6">
      <input id="q" type="search" placeholder="Cari produk…" class="w-full rounded-3xl px-5 py-3 outline-none border" />
    </div>

    {products.length === 0 ? (
      <div class="rounded-3xl border p-6 text-center opacity-80">
        <p class="mb-1">Belum ada produk.</p>
        <small>Tambahkan file di <code>src/content/products/*.md</code> untuk mulai menampilkan produk.</small>
      </div>
    ) : (
      <div id="grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2">
        {products.map((p) => (
          <ProductCard
            title={p.title}
            slug={p.slug}
            price={p.price}
            currency={p.currency}
            excerpt={p.excerpt}
            images={p.images}
          />
        ))}
      </div>
    )}
  </section>

  <script is:inline>
    // pencarian ringan di client
    const q = document.getElementById('q') as HTMLInputElement | null;
    const grid = document.getElementById('grid');
    if (q && grid) {
      q.addEventListener('input', () => {
        const term = q.value.toLowerCase();
        grid.querySelectorAll('article')?.forEach((card) => {
          const text = card.textContent?.toLowerCase() ?? '';
          (card as HTMLElement).style.display = text.includes(term) ? '' : 'none';
        });
      });
    }
  </script>
</MainLayout>
