---
import { getCollection } from "astro:content";
import MainLayout from "../../layouts/MainLayout.astro";
import ProductCard from "../../components/ProductCard.astro";
import siteConfig from "../../site.config";
import { sortItemsByDateDesc } from "../../utils/helpers";

const items = (await getCollection("products")).sort(sortItemsByDateDesc);

const pageTitle = siteConfig.title + " | Produk";
const pageDescription = "Katalog produk Twotworial—mebel & aksesoris siap pakai.";
const canonical = new URL("/products/", Astro.site ?? siteConfig.website ?? "https://twotworial.com").href;
---

<MainLayout
  activePage="products"
  pageTitle={pageTitle}
  description={pageDescription}
  breadcrumbTitle="Products"
>
  <head>
    <link rel="canonical" href={canonical} />
    <!-- JSON-LD: CollectionPage + ItemList -->
    <script type="application/ld+json" is:inline>
      {JSON.stringify({
        "@context":"https://schema.org",
        "@type":"CollectionPage",
        "name":"Products",
        "mainEntity": {
          "@type":"ItemList",
          "itemListElement": items.map((p,i)=>({
            "@type":"ListItem",
            "position": i+1,
            "url": new URL(`/products/${p.slug ?? p.id}/`, Astro.site ?? "https://twotworial.com").href,
            "name": p.data.title
          }))
        }
      })}
    </script>
  </head>

  <section class="page-content">
    <h1>Products</h1>

    <form method="get" class="mb-6">
      <input
        class="w-full rounded-3xl px-5 py-3"
        type="search"
        name="q"
        placeholder="Cari produk…"
        value={Astro.url.searchParams.get("q") ?? ""}
      />
    </form>

    {items.length === 0 ? (
      <div class="rounded-2xl border p-6 text-center">
        <p class="mb-2">Belum ada produk.</p>
        <p class="meta">Tambahkan file di <code>src/content/products/*.md</code> untuk mulai menampilkan produk.</p>
      </div>
    ) : (
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {items
          .filter(p=>{
            const q = (Astro.url.searchParams.get("q") ?? "").toLowerCase();
            if(!q) return true;
            const d = p.data;
            return [d.title, d.excerpt, ...(d.tags ?? [])].join(" ").toLowerCase().includes(q);
          })
          .map(p => <ProductCard product={p} />)}
      </div>
    )}
  </section>
</MainLayout>
