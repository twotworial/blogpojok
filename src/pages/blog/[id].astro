---
import "../../styles/global.css";
import type { CollectionEntry } from "astro:content";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Button from "../../components/Button.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import ArrowLeft from "../../icons/ArrowLeft.astro";
import ArrowRight from "../../icons/ArrowRight.astro";
import { sortItemsByDateDesc, createSlugFromTitle, withBase } from "../../utils/helpers";

export async function getStaticPaths() {
  const posts = (await getCollection("blogs")).sort(sortItemsByDateDesc);
  const postCount = posts.length;

  return posts.map((post, index) => ({
    params: { id: post.id },
    props: {
      post,
      prevPost: index + 1 !== postCount ? posts[index + 1] : null,
      nextPost: index !== 0 ? posts[index - 1] : null,
    },
  }));
}

type Props = {
  post: CollectionEntry<"blogs">;
  prevPost: CollectionEntry<"blogs"> | null;
  nextPost: CollectionEntry<"blogs"> | null;
};

const { post, prevPost, nextPost } = Astro.props as Props;
const { title, pubDate, author = "Twotworial", tags = [], image } = post.data;
const { Content } = await render(post);

type ResolvedImg =
  | { kind: "asset"; src: any; alt: string }
  | { kind: "external"; src: string; alt: string };

function resolveImage(img: unknown, fallbackAlt: string): ResolvedImg | null {
  if (!img) return null;

  if (typeof img === "object" && img !== null && "src" in (img as any) && "width" in (img as any)) {
    const meta = img as any;
    const alt = meta.alt ?? fallbackAlt;
    return { kind: "asset", src: meta, alt };
  }

  if (typeof img === "object" && img !== null && "url" in (img as any)) {
    const obj = img as any;
    const alt = obj.alt ?? fallbackAlt;

    if (obj.url && typeof obj.url === "object" && "src" in obj.url && "width" in obj.url) {
      return { kind: "asset", src: obj.url, alt };
    }
    if (typeof obj.url === "string") {
      return { kind: "external", src: obj.url, alt };
    }
  }

  if (typeof img === "string") {
    return { kind: "external", src: img, alt: fallbackAlt };
  }

  return null;
}

const cover = resolveImage(image, title);
---

<MainLayout pageTitle={`${title} | Twotworial`}>
  <div class="page-content">
    <h1 class="sigmar-ff text-center text-balance">{title}</h1>

    <p class="kanit-regular text-center text-xs">
      by üßë‚ÄçüöÄ <span class="kanit-bold">{author}</span> pada{" "}
      <span class="kanit-bold">
        {new Date(pubDate).toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "long",
          year: "numeric",
        })}
      </span>
    </p>

    {cover && cover.kind === "asset" && (
      <Image
        class="my-6 rounded-xl"
        src={cover.src}
        alt={cover.alt}
        loading="eager"
        decoding="async"
        sizes="(max-width: 768px) 92vw, 768px"
      />
    )}
    {cover && cover.kind === "external" && (
      <img
        class="my-6 rounded-xl"
        src={cover.src}
        alt={cover.alt}
        loading="eager"
        decoding="async"
        referrerpolicy="no-referrer"
      />
    )}

    <div class="font-light text-left">
      <Content />
    </div>

    {tags.length > 0 && (
      <p class="kanit-regular text-center text-balance text-xs">
        Tagged:
        {tags.map((tag) => (
          <Button class="px-4! m-2" href={withBase("/tags/" + createSlugFromTitle(tag))}>
            {tag}
          </Button>
        ))}
      </p>
    )}

    <div class="my-8 flex flex-col items-center justify-center gap-4 sm:flex-row">
      <Button class="back-link" href={withBase("/blog")}>
        <ArrowLeft class="mr-4 h-5 w-5 fill-current" /> Semua Artikel
      </Button>

      {prevPost && (
        <Button class="back-link text-balance" href={withBase("/blog/" + prevPost.id)}>
          <ArrowLeft class="mr-4 h-5 w-5 fill-current" /> {prevPost.data.title}
        </Button>
      )}
      {nextPost && (
        <Button class="back-link text-balance" href={withBase("/blog/" + nextPost.id)}>
          {nextPost.data.title} <ArrowRight class="ml-4 h-5 w-5 fill-current" />
        </Button>
      )}
    </div>
  </div>
</MainLayout>
