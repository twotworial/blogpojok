---
import "../../styles/global.css";
import type { CollectionEntry, RenderedContent } from "astro:content";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Button from "../../components/Button.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import ArrowLeft from "../../icons/ArrowLeft.astro";
import ArrowRight from "../../icons/ArrowRight.astro";
import { sortItemsByDateDesc, createSlugFromTitle, withBase } from "../../utils/helpers";
import siteConfig from "../../site.config";

/* ==== ICONS (inline SVG) ==== */
import IconX from "../../icons/x.svg?raw";
import IconFacebook from "../../icons/facebook.svg?raw";
import IconLinkedIn from "../../icons/linkedin.svg?raw";
import IconWhatsApp from "../../icons/whatsapp.svg?raw";
import IconThreads from "../../icons/threads.svg?raw";
import IconEmail from "../../icons/email.svg?raw";
import IconClipboard from "../../icons/clipboard.svg?raw";
import IconPinterest from "../../icons/pinterest.svg?raw";

export async function getStaticPaths() {
  const posts = (await getCollection("blogs")).sort(sortItemsByDateDesc);
  const postCount = posts.length;

  return posts.map((post, index) => ({
    params: { id: post.id },
    props: {
      post,
      prevPost: index + 1 !== postCount ? posts[index + 1] : null,
      nextPost: index !== 0 ? posts[index - 1] : null,
    },
  }));
}

type Props = {
  post: CollectionEntry<"blogs">;
  prevPost: CollectionEntry<"blogs"> | null;
  nextPost: CollectionEntry<"blogs"> | null;
};

const { post, prevPost, nextPost } = Astro.props as Props;

/* Content + headings (untuk TOC) */
const { Content, headings } = (await render(post)) as RenderedContent & {
  headings: Array<{ depth: number; slug: string; text: string }>;
};

/* title aman dari awalan "$" */
const safeTitle = (post.data.title ?? "").replace(/^\s*\$/, "");
const pubDate = post.data.pubDate;
const author = post.data.author ?? "Twotworial";
const tags = post.data.tags ?? [];
const image = post.data.image;

/* Resolve cover dari schema fleksibel */
type ResolvedImg =
  | { kind: "asset"; src: any; alt: string }
  | { kind: "external"; src: string; alt: string };

function resolveImage(img: unknown, fallbackAlt: string): ResolvedImg | null {
  if (!img) return null;

  if (typeof img === "object" && img !== null && "src" in (img as any) && "width" in (img as any)) {
    const meta = img as any;
    return { kind: "asset", src: meta, alt: (meta.alt ?? fallbackAlt) as string };
  }
  if (typeof img === "object" && img !== null && "url" in (img as any)) {
    const obj = img as any;
    const alt = obj.alt ?? fallbackAlt;
    if (obj.url && typeof obj.url === "object" && "src" in obj.url && "width" in obj.url) {
      return { kind: "asset", src: obj.url, alt };
    }
    if (typeof obj.url === "string") return { kind: "external", src: obj.url, alt };
  }
  if (typeof img === "string") return { kind: "external", src: img, alt: fallbackAlt };
  return null;
}

const cover = resolveImage(image, safeTitle);

/* Absolute page & image URL buat share/OG */
const slug = Astro.params.id!;
const pagePath = withBase(`/blog/${slug}`);
const baseOrigin =
  (Astro.site && Astro.site.origin) ||
  (siteConfig as any)?.baseUrl ||
  "https://twotworial.com";
const pageUrl = new URL(pagePath, baseOrigin).toString();

let shareImageUrl: string | null = null;
if (cover?.kind === "external") {
  shareImageUrl = cover.src;
} else if (cover?.kind === "asset" && cover.src?.src) {
  // cover.src adalah ImageMetadata â†’ cover.src.src = path hasil build
  shareImageUrl = new URL(cover.src.src, baseOrigin).toString();
}

/* Estimasi waktu baca */
const rawBody = post.body ?? "";
const words = (rawBody.match(/\S+/g) ?? []).length;
const readMinutes = Math.max(1, Math.ceil(words / 200));
---

<MainLayout
  pageTitle={`${safeTitle} | Twotworial`}
  image={shareImageUrl ?? siteConfig.image?.src}
>
  <!-- Progress bar baca -->
  <div id="read-progress" style="position:sticky;top:0;left:0;right:0;height:4px;background:transparent;z-index:50;">
    <div id="read-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#90393a,#ffff85);transition:width .1s linear;"></div>
  </div>

  <div class="page-content">
    <h1 class="sigmar-ff text-center text-balance">{safeTitle}</h1>

    <p class="kanit-regular mt-1 text-center text-xs opacity-80">
      by ðŸŒ± <span class="kanit-bold">{author}</span> â€¢{" "}
      <span class="kanit-bold">
        {new Date(pubDate).toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" })}
      </span>
      {" "}â€¢ {readMinutes} min read
    </p>

    <!-- Share (ikon saja, termasuk Pinterest) -->
    <div class="mt-4 mb-6 flex justify-center">
      <div class="flex items-center gap-3">
        <a aria-label="Share on X" href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(safeTitle)}&url=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconX} /></a>
        <a aria-label="Share on Facebook" href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconFacebook} /></a>
        <a aria-label="Share on LinkedIn" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconLinkedIn} /></a>
        <a aria-label="Share on WhatsApp" href={`https://api.whatsapp.com/send?text=${encodeURIComponent(safeTitle + " " + pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconWhatsApp} /></a>
        <a aria-label="Share on Threads" href={`https://www.threads.net/intent/post?text=${encodeURIComponent(safeTitle + " " + pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconThreads} /></a>
        <a aria-label="Share on Pinterest" href={`https://www.pinterest.com/pin/create/button/?url=${encodeURIComponent(pageUrl)}${shareImageUrl ? `&media=${encodeURIComponent(shareImageUrl)}` : ""}&description=${encodeURIComponent(safeTitle)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconPinterest} /></a>
        <a aria-label="Share via Email" href={`mailto:?subject=${encodeURIComponent(safeTitle)}&body=${encodeURIComponent(pageUrl)}`} class="inline-flex rounded-full border px-3 py-2 hover:opacity-80"><span class="block h-4 w-4" set:html={IconEmail} /></a>
        <button aria-label="Copy link" type="button" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80" onclick={`navigator.clipboard.writeText('${pageUrl}').then(()=>{ const t=document.getElementById('copy-toast'); if(t){ t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',1200);} });`}><span class="block h-4 w-4" set:html={IconClipboard} /></button>
      </div>
    </div>
    <div id="copy-toast" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:6px 10px;border-radius:12px;opacity:0;transition:opacity .2s;">Link disalin</div>

    <!-- Cover -->
    {cover && cover.kind === "asset" && (
      <Image class="my-6 rounded-xl" src={cover.src} alt={cover.alt} loading="eager" decoding="async" sizes="(max-width: 768px) 92vw, 768px" />
    )}
    {cover && cover.kind === "external" && (
      <img class="my-6 rounded-xl" src={cover.src} alt={cover.alt} loading="eager" decoding="async" referrerpolicy="no-referrer" />
    )}

    <!-- TOC -->
    {headings && headings.length > 0 && (
      <aside class="mb-8 rounded-2xl border p-4">
        <h2 class="mb-2 text-sm font-semibold opacity-80">Daftar Isi</h2>
        <ol class="space-y-1 text-sm">
          {headings.filter((h) => h.depth <= 3).map((h) => (
            <li class={`pl-${(h.depth - 1) * 3}`}>
              <a href={`#${h.slug}`} class="hover:underline">{h.text}</a>
            </li>
          ))}
        </ol>
      </aside>
    )}

    <!-- Konten -->
    <article class="font-light text-left prose max-w-none">
      <Content />
    </article>

    <!-- Tags -->
    {tags.length > 0 && (
      <p class="kanit-regular text-center text-balance text-xs mt-8">
        Tagged:
        {tags.map((tag) => (
          <Button class="px-4! m-2" href={withBase("/tags/" + createSlugFromTitle(tag))}>{tag}</Button>
        ))}
      </p>
    )}

    <!-- Navigasi prev/next -->
    <div class="my-8 flex flex-col items-center justify-center gap-4 sm:flex-row">
      <Button class="back-link" href={withBase("/blog")}><ArrowLeft class="mr-4 h-5 w-5 fill-current" /> Semua Artikel</Button>
      {prevPost && (<Button class="back-link text-balance" href={withBase("/blog/" + prevPost.id)}><ArrowLeft class="mr-4 h-5 w-5 fill-current" /> {prevPost.data.title}</Button>)}
      {nextPost && (<Button class="back-link text-balance" href={withBase("/blog/" + nextPost.id)}>{nextPost.data.title} <ArrowRight class="ml-4 h-5 w-5 fill-current" /></Button>)}
    </div>

    <!-- DISQUS: one-click load, DIBAWAH prev/next -->
    <section class="mt-6">
      <button
        type="button"
        class="button-link space-btn-outlined"
        onclick="
          (function(){
            var c=document.getElementById('disqus_container');
            if(!c || c.dataset.loaded==='1') return;
            window.disqus_config=function(){
              this.page.url = `${location.origin}${location.pathname}`;
              this.page.identifier = `${encodeURIComponent(location.pathname)}`;
              this.page.title = `${document.title}`;
            };
            var d=document, s=d.createElement('script');
            s.src='https://twotworial.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head||d.body).appendChild(s);
            c.dataset.loaded='1';
            var btn=d.getElementById('load_disqus_btn'); if(btn) btn.style.display='none';
          })();
        "
        id="load_disqus_btn"
      >Tampilkan Komentar</button>
      <div id="disqus_container" class="mt-4" data-loaded="0"><div id="disqus_thread"></div></div>
    </section>
  </div>

  <!-- Disqus count (opsional) -->
  <script id="dsq-count-scr" src="//twotworial.disqus.com/count.js" async></script>

  <!-- Progress baca -->
  <script is:inline>
    (function(){
      const bar = document.getElementById('read-progress-bar');
      const article = document.querySelector('article');
      if(!bar || !article) return;
      const onScroll = () => {
        const winH = window.innerHeight || document.documentElement.clientHeight;
        const docTop = article.offsetTop;
        const docH = article.scrollHeight;
        const total = Math.max(0, docH - winH);
        const scrolled = Math.min(Math.max(window.scrollY - docTop, 0), total);
        const pct = total > 0 ? (scrolled / total) * 100 : 0;
        bar.style.width = pct.toFixed(2) + '%';
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onScroll);
      onScroll();
    })();
  </script>
</MainLayout>
