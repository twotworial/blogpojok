---
import "../../styles/global.css";
import type { CollectionEntry, RenderedContent } from "astro:content";
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Button from "../../components/Button.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import ArrowLeft from "../../icons/ArrowLeft.astro";
import ArrowRight from "../../icons/ArrowRight.astro";
import { sortItemsByDateDesc, createSlugFromTitle, withBase } from "../../utils/helpers";
import siteConfig from "../../site.config";

export async function getStaticPaths() {
  const posts = (await getCollection("blogs")).sort(sortItemsByDateDesc);
  const postCount = posts.length;

  return posts.map((post, index) => ({
    params: { id: post.id },
    props: {
      post,
      prevPost: index + 1 !== postCount ? posts[index + 1] : null,
      nextPost: index !== 0 ? posts[index - 1] : null,
    },
  }));
}

type Props = {
  post: CollectionEntry<"blogs">;
  prevPost: CollectionEntry<"blogs"> | null;
  nextPost: CollectionEntry<"blogs"> | null;
};

const { post, prevPost, nextPost } = Astro.props as Props;

// ambil Content + headings buat TOC
const { Content, headings } = (await render(post)) as RenderedContent & {
  headings: Array<{ depth: number; slug: string; text: string }>;
};

// title aman dari awalan "$"
const safeTitle = (post.data.title ?? "").replace(/^\s*\$/,"");

const pubDate = post.data.pubDate;
const author = post.data.author ?? "Twotworial";
const tags = post.data.tags ?? [];
const image = post.data.image;

// resolve cover dari berbagai bentuk schema
type ResolvedImg =
  | { kind: "asset"; src: any; alt: string }
  | { kind: "external"; src: string; alt: string };

function resolveImage(img: unknown, fallbackAlt: string): ResolvedImg | null {
  if (!img) return null;

  if (typeof img === "object" && img !== null && "src" in (img as any) && "width" in (img as any)) {
    const meta = img as any;
    return { kind: "asset", src: meta, alt: (meta.alt ?? fallbackAlt) as string };
  }
  if (typeof img === "object" && img !== null && "url" in (img as any)) {
    const obj = img as any;
    const alt = obj.alt ?? fallbackAlt;
    if (obj.url && typeof obj.url === "object" && "src" in obj.url && "width" in obj.url) {
      return { kind: "asset", src: obj.url, alt };
    }
    if (typeof obj.url === "string") {
      return { kind: "external", src: obj.url, alt };
    }
  }
  if (typeof img === "string") {
    return { kind: "external", src: img, alt: fallbackAlt };
  }
  return null;
}

const cover = resolveImage(image, safeTitle);

// absolute URL utk share & disqus
const slug = Astro.params.id!;
const pagePath = withBase(`/blog/${slug}`);
const baseOrigin =
  (Astro.site && Astro.site.origin) ||
  (siteConfig as any)?.baseUrl ||
  "https://twotworial.com";
const pageUrl = new URL(pagePath, baseOrigin).toString();

// read time (‚âà200 wpm)
const rawBody = post.body ?? "";
const words = (rawBody.match(/\S+/g) ?? []).length;
const readMinutes = Math.max(1, Math.ceil(words / 200));
---

<MainLayout pageTitle={`${safeTitle} | Twotworial`}>
  <!-- progress bar baca -->
  <div id="read-progress" style="position:sticky;top:0;left:0;right:0;height:4px;background:transparent;z-index:50;">
    <div id="read-progress-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#90393a,#ffff85);transition:width .1s linear;"></div>
  </div>

  <div class="page-content">
    <h1 class="sigmar-ff text-center text-balance">{safeTitle}</h1>

    <p class="kanit-regular mt-1 text-center text-xs opacity-80">
      by üßë‚ÄçüöÄ <span class="kanit-bold">{author}</span> ‚Ä¢{" "}
      <span class="kanit-bold">
        {new Date(pubDate).toLocaleDateString("id-ID", { day: "2-digit", month: "long", year: "numeric" })}
      </span>
      {" "}‚Ä¢ {readMinutes} min read
    </p>

    <!-- Share (ikon saja) -->
    <div class="mt-4 mb-6 flex justify-center">
      <div class="flex items-center gap-3">
        <a aria-label="Share on X" href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(safeTitle)}&url=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- X -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2H21l-6.69 7.637L22 22h-6.828l-4.78-6.22L4.8 22H2.043l7.19-8.218L2 2h6.914l4.33 5.67L18.244 2zm-2.39 18h2.122L8.22 4H6.006l9.848 16z"/></svg>
        </a>
        <a aria-label="Share on Facebook" href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- FB -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12.07C22 6.48 17.52 2 11.93 2S2 6.48 2 12.07c0 5 3.66 9.14 8.44 9.93v-7.02H7.9V12.07h2.54V9.83c0-2.5 1.5-3.89 3.79-3.89 1.1 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.62.77-1.62 1.56v1.89h2.77l-.44 2.91h-2.33v7.02C18.34 21.21 22 17.07 22 12.07z"/></svg>
        </a>
        <a aria-label="Share on LinkedIn" href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- IN -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6.94 6.5A2.44 2.44 0 1 1 4.5 4.06 2.44 2.44 0 0 1 6.94 6.5ZM4.74 20h4.4V9.33h-4.4Zm6.53-10.67V20h4.4v-5.64c0-3 3.86-3.25 3.86 0V20h4.4v-6.89c0-6.2-6.87-5.97-8.26-2.92v-1.86Z"/></svg>
        </a>
        <a aria-label="Share on WhatsApp" href={`https://api.whatsapp.com/send?text=${encodeURIComponent(safeTitle + " " + pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- WA -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.86 11.86 0 0 0 3.47 20.53L2 22l1.57-.41A11.86 11.86 0 1 0 20.52 3.48ZM6.6 18.12l-.1.06-1 .26.27-.97.06-.1a9.8 9.8 0 1 1 3.6 3.58l-.1.06-2.73.71ZM8.7 7.7c-.2-.44-.4-.45-.58-.46h-.5c-.18 0-.46.07-.7.34s-.92.9-.92 2.2.94 2.55 1.06 2.73 1.83 2.94 4.49 4c2.22.88 2.67.71 3.15.67s1.55-.63 1.77-1.23a2 2 0 0 0 .13-1.23c-.05-.1-.2-.16-.42-.28s-1.3-.64-1.5-.71-.35-.1-.5.1-.57.71-.7.86-.26.16-.48.06a7.93 7.93 0 0 1-2.35-1.45 8.8 8.8 0 0 1-1.62-2 2.23 2.23 0 0 1-.2-.47c0-.1.06-.22.14-.3s.2-.26.3-.4.13-.23.2-.38.03-.29 0-.4-.5-1.2-.7-1.63Z"/></svg>
        </a>
        <a aria-label="Share on Threads" href={`https://www.threads.net/intent/post?text=${encodeURIComponent(safeTitle + " " + pageUrl)}`} target="_blank" rel="noopener" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- Threads -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c5.52 0 10 4.48 10 10s-4.48 10-10 10S2 17.52 2 12 6.48 2 12 2Zm5.2 9.07c-.25-1.87-1.24-3.26-2.85-4.05a6.7 6.7 0 0 0-2.9-.57c-2.88 0-5.1 1.9-5.1 4.43 0 2.12 1.54 3.73 3.84 4.07.3.05.6.08.91.1-.4.3-.73.67-.98 1.09-.43.75-.47 1.61-.13 2.36.39.89 1.32 1.5 2.45 1.5 2 0 3.5-1.63 3.5-3.79v-1.33c.8-.37 1.54-.96 1.76-1.78.08-.32.1-.68 0-1.03ZM12.9 9.6c1.14.05 1.92.69 2.05 1.8-1.2.7-2.66 1.06-4.1.98-1.16-.07-1.9-.7-1.9-1.65 0-.97.9-1.76 2.1-1.76.62 0 1.22.23 1.85.63Z"/></svg>
        </a>
        <a aria-label="Share via Email" href={`mailto:?subject=${encodeURIComponent(safeTitle)}&body=${encodeURIComponent(pageUrl)}`} class="inline-flex rounded-full border px-3 py-2 hover:opacity-80">
          <!-- Email -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4.2-8 5-8-5V6l8 5 8-5v2.2Z"/></svg>
        </a>
        <button aria-label="Copy link" type="button" class="inline-flex rounded-full border px-3 py-2 hover:opacity-80" onclick={`navigator.clipboard.writeText('${pageUrl}').then(()=>{ const t=document.getElementById('copy-toast'); if(t){ t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',1200);} });`}>
          <!-- Copy -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h11v14Z"/></svg>
        </button>
      </div>
    </div>
    <div id="copy-toast" style="position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#000;color:#fff;padding:6px 10px;border-radius:12px;opacity:0;transition:opacity .2s;">Link disalin</div>

    <!-- Cover -->
    {cover && cover.kind === "asset" && (
      <Image
        class="my-6 rounded-xl"
        src={cover.src}
        alt={cover.alt}
        loading="eager"
        decoding="async"
        sizes="(max-width: 768px) 92vw, 768px"
      />
    )}
    {cover && cover.kind === "external" && (
      <img class="my-6 rounded-xl" src={cover.src} alt={cover.alt} loading="eager" decoding="async" referrerpolicy="no-referrer" />
    )}

    <!-- TOC -->
    {headings && headings.length > 0 && (
      <aside class="mb-8 rounded-2xl border p-4">
        <h2 class="mb-2 text-sm font-semibold opacity-80">Daftar Isi</h2>
        <ol class="space-y-1 text-sm">
          {headings
            .filter(h => h.depth <= 3)
            .map(h => (
              <li class={`pl-${(h.depth-1)*3}`}>
                <a href={`#${h.slug}`} class="hover:underline">{h.text}</a>
              </li>
            ))}
        </ol>
      </aside>
    )}

    <!-- Konten -->
    <article class="font-light text-left prose max-w-none">
      <Content />
    </article>

    <!-- Tags -->
    {tags.length > 0 && (
      <p class="kanit-regular text-center text-balance text-xs mt-8">
        Tagged:
        {tags.map((tag) => (
          <Button class="px-4! m-2" href={withBase("/tags/" + createSlugFromTitle(tag))}>
            {tag}
          </Button>
        ))}
      </p>
    )}

    <!-- Navigasi prev/next -->
    <div class="my-8 flex flex-col items-center justify-center gap-4 sm:flex-row">
      <Button class="back-link" href={withBase("/blog")}>
        <ArrowLeft class="mr-4 h-5 w-5 fill-current" /> Semua Artikel
      </Button>

      {prevPost && (
        <Button class="back-link text-balance" href={withBase("/blog/" + prevPost.id)}>
          <ArrowLeft class="mr-4 h-5 w-5 fill-current" /> {prevPost.data.title}
        </Button>
      )}
      {nextPost && (
        <Button class="back-link text-balance" href={withBase("/blog/" + nextPost.id)}>
          {nextPost.data.title} <ArrowRight class="ml-4 h-5 w-5 fill-current" />
        </Button>
      )}
    </div>

    <!-- DISQUS: one-click load & diletakkan DI BAWAH navigasi -->
    <section class="mt-6">
      <button
        type="button"
        class="button-link space-btn-outlined"
        onclick="
          (function(){
            var c=document.getElementById('disqus_container');
            if(!c) return;
            if(c.dataset.loaded==='1') return;
            window.disqus_config=function(){
              this.page.url = `${location.origin}${location.pathname}`;
              this.page.identifier = `${encodeURIComponent(location.pathname)}`;
              this.page.title = `${document.title}`;
            };
            var d=document, s=d.createElement('script');
            s.src='https://twotworial.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head||d.body).appendChild(s);
            c.dataset.loaded='1';
            var btn=d.getElementById('load_disqus_btn'); if(btn) btn.style.display='none';
          })();
        "
        id="load_disqus_btn"
      >
        Tampilkan Komentar
      </button>
      <div id="disqus_container" class="mt-4" data-loaded="0">
        <div id="disqus_thread"></div>
      </div>
    </section>
  </div>

  <!-- Disqus count script bisa ditaruh di layout global juga -->
  <script id="dsq-count-scr" src="//twotworial.disqus.com/count.js" async></script>

  <!-- Progress baca -->
  <script is:inline>
    (function(){
      const bar = document.getElementById('read-progress-bar');
      const article = document.querySelector('article');
      if(!bar || !article) return;

      const onScroll = () => {
        const rect = article.getBoundingClientRect();
        const winH = window.innerHeight || document.documentElement.clientHeight;
        const docH = article.scrollHeight;
        const total = docH - winH;
        const scrolled = Math.min(Math.max(window.scrollY - (article.offsetTop - 0), 0), total);
        const pct = total > 0 ? (scrolled / total) * 100 : 0;
        bar.style.width = pct.toFixed(2) + '%';
      };
      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onScroll);
      onScroll();
    })();
  </script>
</MainLayout>
