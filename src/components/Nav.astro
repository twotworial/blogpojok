---
import siteConfig from "../site.config";
import Hamburger from "./Hamburger.astro";
import ThemeSwitcher from "./ThemeSwitcher.astro";
import SiteIdentity from "./SiteIdentity.astro";
import NavLinks from "./NavLinks.astro";
import { withBase } from "../utils/helpers";

const { activePage } = Astro.props;
---

<header>
  <nav class="w-full font-light flex items-center justify-between gap-3">
    <!-- Logo / Brand -->
    <a href={withBase("/")} class="shrink-0" aria-label="Beranda">
      <SiteIdentity />
    </a>

    <!-- Desktop links -->
    <div class="hidden sm:flex sm:gap-8">
      <NavLinks activePage={activePage} links={siteConfig.headerNavLinks} />
    </div>

    <!-- Right tools -->
    <div class="flex items-center gap-2">
      <ThemeSwitcher />
      <!-- Pastikan komponen Hamburger menghasilkan button#hamburger-menu -->
      <Hamburger />
    </div>
  </nav>

  <!-- Mobile sheet (default: hidden) -->
  <div
    id="mobile-links"
    class="hidden fixed inset-x-0 top-0 z-50 w-screen rounded-b-xl px-6 pb-4 pt-4
           backdrop-blur-2xl
           bg-black/70 text-white
           sm:hidden"
    role="dialog"
    aria-modal="true"
    aria-labelledby="mobile-menu-title"
  >
    <div class="flex items-center justify-between">
      <h2 id="mobile-menu-title" class="text-base font-medium">Menu</h2>
      <button
        type="button"
        class="close-menu inline-flex items-center justify-center rounded-md px-3 py-2 text-sm ring-1 ring-white/30 hover:ring-white/60"
        aria-label="Tutup menu"
      >
        âœ•
      </button>
    </div>

    <div class="mt-3 border-t border-white/20 pt-3">
      <NavLinks
        activePage={activePage}
        links={siteConfig.headerNavLinks}
        isMobileLink={true}
      />
    </div>
  </div>
</header>

<script is:inline>
  (function () {
    const btn = document.querySelector("#hamburger-menu");
    const sheet = document.querySelector("#mobile-links");
    const closeBtn = sheet?.querySelector(".close-menu");
    const focusableSelector = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';

    if (!btn || !sheet) return;

    const open = () => {
      // tampilkan sheet
      sheet.classList.remove("hidden");
      // kunci scroll body
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      // a11y
      btn.setAttribute("aria-expanded", "true");
      // fokuskan elemen pertama
      const first = sheet.querySelector(focusableSelector);
      if (first) first.focus();
    };

    const close = () => {
      sheet.classList.add("hidden");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      btn.setAttribute("aria-expanded", "false");
      btn.focus();
    };

    // toggle open
    btn.addEventListener("click", () => {
      const isHidden = sheet.classList.contains("hidden");
      if (isHidden) open(); else close();
    });

    // close by button X
    if (closeBtn) closeBtn.addEventListener("click", close);

    // close when clicking outside content (padding area)
    sheet.addEventListener("click", (e) => {
      // jika klik di area sheet yang bukan link/container isi
      const contentClicked = (e.target).closest("a, button, nav, ul, li, .close-menu");
      if (!contentClicked) close();
    });

    // close on ESC
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !sheet.classList.contains("hidden")) {
        close();
      }
    });

    // close setelah pilih link (UX lebih enak)
    sheet.addEventListener("click", (e) => {
      const anchor = (e.target).closest("a");
      if (anchor) close();
    });
  })();
</script>

<style>
  /* Versi light/dark background untuk sheet */
  html.light #mobile-links {
    background-color: color-mix(in oklab, #ffffff 70%, transparent);
    color: #0c0c0c;
  }

  /* Sedikit bayangan halus untuk nav dan sheet */
  header > nav {
    box-shadow:
      inset 0 0 0.5px 1px hsla(0,0%,100%,0.04),
      0 0 0 1px hsla(0,0%,0%,0.04),
      0 .3px .4px hsla(0,0%,0%,0.02),
      0 .9px 1.5px hsla(0,0%,0%,0.04),
      0 3.5px 6px hsla(0,0%,0%,0.07);
  }

  /* Biar sheet tidak nempel ke tepi layar yang punya notch */
  #mobile-links {
    padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
    padding-left:  max(24px, env(safe-area-inset-left, 0px));
    padding-right: max(24px, env(safe-area-inset-right, 0px));
  }
</style>
